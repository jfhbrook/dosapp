#!/usr/bin/env bash

set -euo pipefail

export DOSAPP_VERSION=1.0.0

# Inject default root with package installer
export DOSAPP_ROOT=''

#
# Logging
#

export DEBUG="${DEBUG:-}"

function log-debug {
  if [ -n "${DEBUG}" ]; then
    echo "DEBUG:" "$@"
  fi
}

function log-info {
  echo "INFO:" "$@"
}

function log-warn {
  echo "WARN:" "$@"
}

function log-error {
  echo "ERROR:" "$@"
}

#
# Configuration
#

function load-config {
  export DOSAPP_ROOT="${DOSAPP_ROOT:-$(dirname "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")")}"
  export DOSAPP_CONFIG_HOME="${DOSAPP_CONFIG_HOME:-${XDG_CONFIG_HOME:-${HOME}/.config}/dosapp}"

  if [ -f "${DOSAPP_CONFIG_HOME}/dosapp.env" ]; then
    # shellcheck disable=SC1091
    source "${DOSAPP_CONFIG_HOME}/dosapp.env"
  fi

  export DEBUG="${DEBUG:-}"
  export DOSAPP_DOSBOX_BIN="${DOSAPP_DOSBOX_BIN:-dosbox-x}"
  export DOSAPP_7Z_BIN="${DOSAPP_7Z_BIN:-7zz}"
  export DOSAPP_DATA_HOME="${DOSAPP_DATA_HOME:-${XDG_DATA_HOME:-${HOME}/.local/share}/dosapp}"
  export DOSAPP_STATE_HOME="${DOSAPP_STATE_HOME:-${XDG_STATE_HOME:-${HOME}/.local/state}/dosapp}"
  export DOSAPP_CACHE_HOME="${DOSAPP_CACHE_HOME:-${XDG_CACHE_HOME:-${HOME}/.cache}/dosapp}"
  export DOSAPP_DISK_HOME="${DOSAPP_DISK_HOME:-${HOME}/dosapp}"
  export DOSAPP_LINK_HOME="${DOSAPP_LINK_HOME:-${HOME}/.local/bin}"
  export DOSAPP_PACKAGE_HOME="${DOSAPP_PACKAGE_HOME:-${DOSAPP_ROOT}/packages}"
  export DOSAPP_DOWNLOAD_HOME="${DOSAPP_DOWNLOAD_HOME:-${DOSAPP_CACHE_HOME}/downloads}"
  export PAGER="${PAGER:-cat}"
  export DOSAPP_DISK_A="${DOSAPP_DISK_A:-${HOME}/Documents}"
  export DOSAPP_DISK_B="${DOSAPP_DISK_B:-}"
  export DOSAPP_DISK_C="${DOSAPP_DISK_C:-${HOME}/dosapp/c}"
}

#
# Command options
#

HELP=''
EDIT='1'
OVERWRITE=''
REFRESH=''
README='1'
REMOVE=''
SUBCOMMAND=''
APP_NAME=''

function parse-argv {
  log-debug "Parsing arguments:" "$@"
  while [[ $# -gt 0 ]]; do
    case "${1}" in
      --no-edit)
        EDIT=''
        shift
        ;;
      -h|--help)
        HELP=1
        shift
        ;;
      --overwrite)
        OVERWRITE=1
        shift
        ;;
      --no-readme)
        README=''
        shift
        ;;
      --refresh)
        REFRESH='1'
        shift
        ;;
      --remove)
        REMOVE=1
        shift
        ;;
      --version)
        echo "v${DOSAPP_VERSION}"
        exit 0
        ;;
      -*)
        log-error "Unknown option: ${1}" 
        exit 1
        ;;
      *)
        if [ -z "${SUBCOMMAND}" ]; then
          SUBCOMMAND="${1}"
          shift
        elif [[ "${SUBCOMMAND}" == install ]] \
          || [[ "${SUBCOMMAND}" == start ]] \
          || [[ "${SUBCOMMAND}" == link ]]; then
          APP_NAME="${1}"
          shift
        else
          log-error "Unknown argument: ${1}"
          exit 1
        fi
        ;;
    esac
  done
}

function require-app {
  if [ -z "${APP_NAME}" ]; then
    log-error "App name is required"
    exit 1
  fi
}

#
# Refresh configuration
#

function refresh-main {
  cp "${DOSAPP_ROOT}/config/Taskfile.yml" "${DOSAPP_CONFIG_HOME}/Taskfile.yml"
  (cd "${DOSAPP_CONFIG_HOME}" && task init)
}

function refresh-app {
  cp "${DOSAPP_PACKAGE_HOME}/${APP_NAME}/Taskfile.yml" "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}/Taskfile.yml"
  cp "${DOSAPP_PACKAGE_HOME}/${APP_NAME}/README.md" "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}/README.md"

  (cd "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}" && task init)
}

function refresh {
  if [ -n "${OVERWRITE}" ] || [ -n "${REFRESH}" ]; then
    refresh-main
    if [ -n "${APP_NAME}" ]; then
      refresh-app
    fi
  else
    log-info "To refresh the configuration, run 'dosapp --refresh'"
  fi
}



#
# Root command
#

function run-root {
  refresh

  (cd "${DOSAPP_CONFIG_HOME}" && task start)
}

function help-root {
  echo "USAGE: dosapp [SUBCOMMAND] [OPTIONS]"
}

#
# Init command
#

function run-init {
  if [ -f "${DOSAPP_CONFIG_HOME}/dosapp.env" ] && [ -z "${OVERWRITE}" ]; then
    log-warn "Environment file already exists at ${DOSAPP_CONFIG_HOME}/dosapp.env"
    log-warn "To overwrite and refresh the configuration, run 'dosapp init --overwrite'"
  else
    REFRESH='1'
    cp "${DOSAPP_ROOT}/config/dosapp.env" "${DOSAPP_CONFIG_HOME}/dosapp.env"
    log-info "Environment file created at ${DOSAPP_CONFIG_HOME}/dosapp.env"
  fi

  if [ -n "${EDIT}" ]; then
    if [ -n "${EDITOR}" ]; then
      ${EDITOR} "${DOSAPP_CONFIG_HOME}/dosapp.env"
    else
      log-warn "EDITOR not defined. Skipping editing env file."
    fi
  else
    log-info "Skipping editing env file."
  fi

  load-config

  if [ ! -f "${DOSAPP_ROOT}/config/Taskfile.yml" ]; then
    REFRESH=1
  fi

  refresh-main
}

function help-init {
  echo "USAGE: dosapp init [OPTIONS]"
}

#
# Install command
#

function run-install {
  require-app

  mkdir -p "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}"

  gomplate -i "$(cat "${DOSAPP_PACKAGE_HOME}/${APP_NAME}/dosapp.env.tmpl")" > "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}/dosapp.env"
  log-info "Environment file written to ${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}/dosapp.env"

  if [ -n "${EDIT}" ]; then
    if [ -n "${EDITOR}" ]; then
      ${EDITOR} "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}/dosapp.env"
    else
      log-warn "EDITOR not defined. Skipping editing env file."
    fi
  else
    log-info "Skipping editing env file."
  fi

  refresh


  if [ -n "${README}" ]; then
    ${PAGER} "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}/README.md"
  else
    log-info "README written to ${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}/README.md"
  fi

  (cd "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}" && task install)
}

function help-install {
  echo "USAGE: dosapp install [APP] [OPTIONS]"
}

#
# Start command
#

function run-start {
  if [ -n "${OVERWRITE}" ] || [ -n "${REFRESH}" ]; then
    (cd "${DOSAPP_CONFIG_HOME}" && task init)
    (cd "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}" && task init)
  else
    log-info "To refresh the configuration, run 'dosapp start ${APP_NAME} --refresh'"
  fi

  (cd "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}" && task start)
}

function help-start {
  echo "USAGE: dosapp start [APP] [OPTIONS]"
}

#
# Link command
#

function run-link {
  require-app

  refresh

  if [ -n "${REMOVE}" ]; then
    (cd "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}" && task remove-link)
  else
    (cd "${DOSAPP_CONFIG_HOME}/apps/${APP_NAME}" && task link)
  fi
}

function help-link {
  echo "USAGE: dosapp link [APP] [OPTIONS]"
}

#
# Main
#

function main {
  load-config

  parse-argv "$@"

  if [ -n "${HELP}" ]; then
    case "${SUBCOMMAND}" in
      init)
        help-init
        ;;
      install)
        help-install
        ;;
      start)
        help-start
        ;;
      link)
        help-link
        ;;
      *)
        help-root
        ;;
    esac
    exit 0
  fi

  if [ -z "${SUBCOMMAND}" ]; then
    run-root
  else
    case "${SUBCOMMAND}" in
      init)
        run-init
        ;;
      install)
        run-install
        ;;
      start)
        run-start
        ;;
      link)
        run-link
        ;;
      *)
        log-error "Unknown subcommand: ${SUBCOMMAND}"
        exit 1
        ;;
    esac
  fi
}

#
# Giddyup.
#

main "$@"
